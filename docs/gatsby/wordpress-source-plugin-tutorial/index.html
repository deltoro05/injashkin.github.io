<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/index.asd.css">
    <script defer src="/index.js"></script>
    <meta name="description" content="Руководство по установке и работе с плагином `gatsby-source-wordpress`, который позволяет извлекать данные из WordPress и использовать на Gatsby сайте">
    <title>Руководство по плагину WordPress Source | jinv.ru</title>
  </head>
  <body>
    <header class="header">
      <div class="header__content content">           
        <div class="header__logo">
          <div class="logo">        <a href="/" title="jinv.ru"> 
              <svg class="icon icon__logo" role="img" width="4em" height="4em">
                <use href="/sprite.svg#logo"></use>
              </svg></a></div>
          <div class="logo-text"> <a href="/" title="jinv.ru">inv.ru</a></div>
          <div class="logo_mobile"><a href="/" title="jinv.ru"><img src="/images/icon-72x72.png" alt="Логотип сайта jinv.ru"/></a></div>
        </div>
        <nav class="menu" aria-label="Главное меню">   
          <div class="content"> 
            <input id="menu__toggle" type="checkbox"/>
            <label class="menu__btn" for="menu__toggle"><span>   </span></label>
            <ul class="menu__box">
              <li><a class="menu__item" href="/">Главная</a></li>
              <li><a class="menu__item" href="/toc.html">Статьи</a></li>
              <li><a class="menu__item" href="/author.html">Об авторе</a></li>
            </ul>
          </div>
        </nav>
        <div class="theme">
          <select id="theme" name="theme">        
            <option value="auto">Авто      </option>
            <option value="light">Светлая      </option>
            <option value="dark">Темная    </option>
          </select>
        </div>
        <div class="header__contacts">
          <div class="send-mes">
            <div class="soc"><a class="mes-em" href="injashkin@gmail.com" title="Email" target="_blank" rel="nofollow">
                <svg class="icon icon__email" role="img" width="1em" height="1em">
                  <use href="/sprite.svg#email"></use>
                </svg></a><a class="mes-tg" href="https://t.me/jashkin" title="Telegram" target="_blank" rel="nofollow">
                <svg class="icon icon__telegram" role="img" width="1em" height="1em">
                  <use href="/sprite.svg#telegram"></use>
                </svg></a><a class="mes-wa" href="https://api.whatsapp.com/send?phone=79183549497" title="WhatsApp" target="_blank" rel="nofollow">
                <svg class="icon icon__whatsapp" role="img" width="1em" height="1em">
                  <use href="/sprite.svg#whatsapp"></use>
                </svg></a>
            </div>
          </div>
          <div class="contacts">         
            <p> <a href="https://github.com/injashkin/injashkin.github.io">Github</a></p>
          </div>
        </div>
      </div>
    </header>
    <div class="content">
      <div class="article">
        <h1>Руководство по плагину WordPress Source</h1>
        <div class="creationDate">Создано: 10-04-2020</div><h2>Как создать сайт с данными, полученными из WordPress</h2>
<p>Перевод статьи <a href="https://www.gatsbyjs.org/tutorial/wordpress-source-plugin-tutorial/#how-to-create-a-site-with-data-pulled-from-wordpress">WordPress Source Plugin Tutorial</a>.</p>
<h3>Что охватывает это руководство:</h3>
<p>В этом руководстве вы установите плагин <code>gatsby-source-wordpress</code>, который извлечет данные и изображения из установленного WordPress на Gatsby сайт и визуализирует эти данные. Этот <a href="https://github.com/gatsbyjs/gatsby/tree/master/examples/using-wordpress">демо-сайт на WordPress + Gatsby </a> содержит исходный код сайта, похожего на тот, что вы построите в этом руководстве, хотя в нем отсутствуют изображения. Их вы добавите изучив руководство <a href="https://www.gatsbyjs.org/tutorial/wordpress-image-tutorial/">Добавление изображений на сайт WordPress</a>.</p>
<h4>Для тех, кто предпочитает GraphQL</h4>
<p>Если вы предпочитаете использовать GraphQL, то существует плагин <a href="https://github.com/wp-graphql/wp-graphql">wp-graphql</a>, который легко отображает как стандартные, так и пользовательские данные в WordPress.</p>
<p>В плагине wp-graphql поддерживаются те же схемы аутентификации, что и в WP-API. Плагин wp-graphql можно использовать совместно с плагином <a href="https://www.gatsbyjs.org/packages/gatsby-source-graphql/">gatsby-source-graphql</a>.</p>
<h2>Зачем это руководство?</h2>
<p>В этом руководстве вы освоите азы по подключению сайта Gatsby к CMS, извлечению данных и использованию React для визуализации этих данных на сайте изящными способами.</p>
<p>Если вы хотите посмотреть на растущее число доступных source плагинов, то в <a href="https://www.gatsbyjs.org/plugins/?=source">Библиотеке плагинов Gatsby</a> в строке поиска введите “source”.</p>
<h3>Создание сайта с помощью плагина <code>gatsby-source-wordpress</code></h3>
<p>Создайте новый проект Gatsby и перейдите в каталог этого проекта:</p>
<pre><code class="language-shell">gatsby new wordpress-tutorial-site
cd wordpress-tutorial-site
</code></pre>
<p>Установите плагин <code>gatsby-source-wordpress</code>. Дополнительные сведения о функциях плагина и примерах запросов GraphQL, не включенных в этот учебник, см. <a href="https://www.gatsbyjs.org/packages/gatsby-source-wordpress/?=wordpress">В файле README плагина <code>gatsby-source-wordpress</code></a>.</p>
<pre><code class="language-shell">npm install gatsby-source-wordpress
</code></pre>
<p>Добавьте плагин <code>gatsby-source-wordpress</code> в файл <code>gatsby-config.js</code> используя следующий код, который вы также найдете в <a href="https://github.com/gatsbyjs/gatsby/blob/master/examples/using-wordpress/gatsby-config.js">исходном коде демо-сайта</a>.</p>
<pre><code class="language-js:title=gatsby-config.js">module.exports = {
  siteMetadata: {
    title: `Учебник Gatsby WordPress`,
    description: `Пример, позволяющий понять, как получить исходные данные из WordPress.`,
    author: `@gatsbyjs`,
  },
  plugins: [
    // https://public-api.wordpress.com/wp/v2/sites/gatsbyjsexamplewordpress.wordpress.com/pages/
    /*
     * Уровень обработки данных Gatsby начинается с плагинов &quot;source&quot;
     * Здесь сайт берет данные из WordPress.
     */
    // highlight-start
    {
      resolve: `gatsby-source-wordpress`,
      options: {
        /*
         * Базовый URL-адрес сайта WordPress без протокола и слеша в конце. Это обязательно.
         * Например : 'demo.wp-api.org' или 'www.example-site.com'
         */
        baseUrl: `live-gatbsyjswp.pantheonsite.io`,
        // Протокол. Может быть http или https.
        protocol: `https`,
        // Указывает, будет ли сайт размещен на wordpress.com.
        // Если false, то подразумевается, что сайт размещен на отдельном хостинге.
        // Если true, то source плагин будет содержаться на wordpress.com используя JSON REST API V2.
        // Если сайт размещен на wordpress.org, то установите это значение в false.
        hostingWPCOM: false,
        // Если useACF - true, то source плагин попытается импортировать содержимое WordPress ACF Plugin.
        // Эта функция непроверена для сайтов, размещенных на WordPress.com
        useACF: true,
      },
    },
    // highlight-end
    /**
     * Следующие плагины не требуются для gatsby-source-wordpress,
     * но они нам нужны, чтобы стартер по умолчанию, который мы установили выше, продолжал работать.
     **/
    `gatsby-plugin-react-helmet`,
    {
      resolve: `gatsby-source-filesystem`,
      options: {
        name: `images`,
        path: `${__dirname}/src/images`,
      },
    },
    `gatsby-transformer-sharp`,
    `gatsby-plugin-sharp`,
    {
      resolve: `gatsby-plugin-manifest`,
      options: {
        name: `gatsby-starter-default`,
        short_name: `starter`,
        start_url: `/`,
        background_color: `#663399`,
        theme_color: `#663399`,
        display: `minimal-ui`,
        icon: `src/images/gatsby-icon.png`, // Этот путь находится относительно корня сайта.
      },
    },
  ],
}
</code></pre>
<h3>Создание GraphQL запросов, которые извлекают данные из WordPress</h3>
<p>Теперь вы можете создать запрос GraphQL, чтобы получить некоторые данные с сайта WordPress. Вы создадите запрос, который извлечет из блога заголовки постов, дату их публикации и содержимое.</p>
<p>Выполните:</p>
<pre><code class="language-shell">gatsby develop
</code></pre>
<p>Перейдите в браузере по ссылке <code>http://localhost:8000</code>, где увидите сайт. Перейдите на <code>http://localhost:8000/___graphql</code>, где сможете создавать запросы GraphQL.</p>
<p>В качестве упражнения попробуйте повторно создать следующие запросы в эксплорере GraphiQL. Этот запрос будет извлекать содержимое поста из блога WordPress:</p>
<pre><code class="language-graphql">query {
  allWordpressPage {
    edges {
      node {
        id
        title
        excerpt
        slug
        date(formatString: &quot;MMMM DD, YYYY&quot;)
      }
    }
  }
}
</code></pre>
<p>Следующий запрос приведет к получению отсортированного списка записей в блоге:</p>
<pre><code class="language-graphql">{
  allWordpressPost(sort: { fields: [date] }) {
    edges {
      node {
        title
        excerpt
        slug
      }
    }
  }
}
</code></pre>
<h2>Рендеринг записей блога в <code>index.js</code></h2>
<p>Теперь, когда вы создали запросы GraphQL, которые извлекают нужные данные, вы будете использовать второй запрос для создания списка отсортированных заголовков постов на главной странице сайта. Вот компонент главной страницы <code>src/pages/index.js</code>, который должен выглядеть так:</p>
<pre><code class="language-jsx:title=src/pages/index.js">import React from &quot;react&quot;
import { graphql } from &quot;gatsby&quot;
import Layout from &quot;../components/layout&quot;
import SEO from &quot;../components/seo&quot;

export default ({ data }) =&gt; {
  //highlight-line
  return (
    &lt;Layout&gt;
      &lt;SEO title=&quot;home&quot; /&gt;
      //highlight-start
      &lt;h1&gt;My WordPress Blog&lt;/h1&gt;
      &lt;h4&gt;Posts&lt;/h4&gt;
      {data.allWordpressPost.edges.map(({ node }) =&gt; (
        &lt;div&gt;
          &lt;p&gt;{node.title}&lt;/p&gt;
          &lt;div dangerouslySetInnerHTML={{ __html: node.excerpt }} /&gt;
        &lt;/div&gt;
      ))}
      //highlight-end
    &lt;/Layout&gt;
  )
}

//highlight-start
export const pageQuery = graphql`
  query {
    allWordpressPost(sort: { fields: [date] }) {
      edges {
        node {
          title
          excerpt
          slug
        }
      }
    }
  }
`
//highlight-end
</code></pre>
<p>Сохраните эти изменения и перейдите на <code>http://localhost:8000</code> чтобы увидеть вашу новую домашнюю страницу со списком отсортированных постов в блоге!</p>
<p><img src="https://www.gatsbyjs.org/static/3ae34e1e5b9f3fbdea14040a88136814/1deb5/wordpress-source-plugin-home.jpg" alt="Главная страница WordPress после запроса"></p>
<h2>Создание страниц для каждого поста блога и ссылки на них</h2>
<p>Индексная страница с заголовком поста и отрывком - это здорово, но вы также должны создать страницы для любого поста в блоге и ссылаться на них из файла <code>index.js</code>.</p>
<p>Для этого необходимо:</p>
<ol>
<li>Создать страницы для каждой поста в блоге</li>
<li>Связать заголовок на странице index со страницей поста.</li>
</ol>
<p>Если вы еще этого не сделали, прочтите <a href="https://www.gatsbyjs.org/tutorial/part-seven/">Часть 7</a> основного руководства, поскольку оно проходит через концепцию и примеры этого процесса используя Markdown вместо WordPress.</p>
<h3>Создание страниц для каждого поста в блоге.</h3>
<p>В части 7 руководства первым шагом в создании страниц является создание слагов для файлов markdown. Поскольку вы используете WordPress, а не файлы Markdown, вы можете захватить слаги, которые возвращаются из вызова API к источнику WordPress. Вы можете пропустить создание слагов, так как они у вас уже есть.</p>
<p>Откройте файл <code>gatsby-node.js</code> в корне проекта (он должен быть пустым, за исключением некоторых комментариев) и добавьте следующее:</p>
<pre><code class="language-js:title=gatsby-node.js">const path = require(`path`)

exports.createPages = ({ graphql, actions }) =&gt; {
  const { createPage } = actions
  return graphql(`
    {
      allWordpressPost(sort: { fields: [date] }) {
        edges {
          node {
            title
            excerpt
            content
            slug
          }
        }
      }
    }
  `).then(result =&gt; {
    console.log(JSON.stringify(result, null, 4))
  })
}
</code></pre>
<p>Затем <a href="https://www.gatsbyjs.org/tutorial/part-zero/#view-your-site-locally">остановите и перезагрузите</a> среду разработки <code>gatsby develop</code>. В терминале, вы должны увидеть два поста, выведенных как объекты:</p>
<p><img src="https://www.gatsbyjs.org/static/3293912ec15e382170fa7e07a8c112c7/28be2/wordpress-source-plugin-log.jpg" alt="Два поста выведенные в терминал"></p>
<p>Как объяснено в части 7 руководства, этот экспорт <code>createPages</code> является одной из “рабочих лошадок” Gatsby и позволяет нам создавать посты в блоге (или страницы, или пользовательские типы записей и т. д.) из установки WordPress.</p>
<p>Однако перед созданием постов в блоге необходимо указать шаблон для построения страниц.</p>
<p>В каталоге <code>src</code> создайте каталог с именем <code>templates</code>, а в нем создайте файл <code>blog-post.js</code>. В этот файл вставьте следующее:</p>
<pre><code class="language-jsx:title=src/templates/blog-post.js">import React from &quot;react&quot;
import Layout from &quot;../components/layout&quot;
import { graphql } from &quot;gatsby&quot;

export default ({ data }) =&gt; {
  const post = data.allWordpressPost.edges[0].node
  console.log(post)
  return (
    &lt;Layout&gt;
      &lt;div&gt;
        &lt;h1&gt;{post.title}&lt;/h1&gt;
        &lt;div dangerouslySetInnerHTML={{ __html: post.content }} /&gt;
      &lt;/div&gt;
    &lt;/Layout&gt;
  )
}
export const query = graphql`
  query($slug: String!) {
    allWordpressPost(filter: { slug: { eq: $slug } }) {
      edges {
        node {
          title
          content
        }
      }
    }
  }
`
</code></pre>
<p>Что делает этот файл? После импорта зависимостей он создает макет поста с помощью JSX. Он оборачивает все в компоненте <code>Layout</code>, поэтому стиль одинаков по всему сайту. Затем он добавляет заголовок сообщения и содержимое сообщения. Вы можете добавить все, что хотите, и можете запросить здесь, например, изображение объекта, мета-запись, пользовательские поля и т. д.</p>
<p>Ниже вы можете увидеть запрос GraphQL, вызывающий конкретную запись на основе <code>$slug</code>. Эта переменная передается в шаблон <code>blog-post.js</code>, когда страница создается в <code>gatsby-node.js</code>. Для этого добавьте следующий код в файл <code>gatsby-node.js</code>:</p>
<pre><code class="language-js:title=gatsby-node.js">const path = require(`path`)

exports.createPages = ({ graphql, actions }) =&gt; {
  const { createPage } = actions
  return graphql(`
    {
      allWordpressPost(sort: { fields: [date] }) {
        edges {
          node {
            title
            excerpt
            content
            slug
          }
        }
      }
    }
  `).then(result =&gt; {
    //highlight-start
    result.data.allWordpressPost.edges.forEach(({ node }) =&gt; {
      createPage({
        path: node.slug,
        component: path.resolve(`./src/templates/blog-post.js`),
        context: {
          // This is the $slug variable
          // passed to blog-post.js
          slug: node.slug,
        },
      })
    })
    //highlight-end
  })
}
</code></pre>
<p>Остановите и запустите среду разработки снова, используя <code>gatsby develop</code>. Когда вы это сделаете, то не увидите изменений на индексной странице сайта, но если перейдете на страницу 404, например <code>http://localhost:8000/asdf</code>, увидите два созданных поста и возможность нажать на них, чтобы перейти к примеру поста:</p>
<p><img src="https://www.gatsbyjs.org/4293822ecf92f5dfc62eef6c01870224/wordpress-source-plugin-sample-post-links.gif" alt="Пример ссылок на посты"></p>
<p>Но никому не нравится заходить на страницу 404, чтобы найти пост в блоге! Итак, давайте свяжем их с домашней страницей.</p>
<h3>Связывание поста с главной страницей.</h3>
<p>Поскольку вы уже имеете структуру и запрос для страницы <code>index.js</code>, то используйте компонент <code>Link</code> для обертывания заголовков.</p>
<p>Откройте <code>src/pages/index.js</code> еще раз и добавьте следующее:</p>
<pre><code class="language-jsx:title=src/pages/index.js">import React from &quot;react&quot;
import { Link, graphql } from &quot;gatsby&quot; //highlight-line
import Layout from &quot;../components/layout&quot;
import SEO from &quot;../components/seo&quot;

export default ({ data }) =&gt; {
  return (
    &lt;Layout&gt;
      &lt;SEO title=&quot;home&quot; /&gt;
      &lt;h1&gt;My WordPress Blog&lt;/h1&gt;
      &lt;h4&gt;Posts&lt;/h4&gt;
      {data.allWordpressPost.edges.map(({ node }) =&gt; (
        &lt;div key={node.slug}&gt;
          //highlight-start
          &lt;Link to={node.slug}&gt;
            &lt;p&gt;{node.title}&lt;/p&gt;
          &lt;/Link&gt;
          //highlight-end
          &lt;div dangerouslySetInnerHTML={{ __html: node.excerpt }} /&gt;
        &lt;/div&gt;
      ))}
    &lt;/Layout&gt;
  )
}

export const pageQuery = graphql`
  query {
    allWordpressPost(sort: { fields: [date] }) {
      edges {
        node {
          title
          excerpt
          slug
        }
      }
    }
  }
`
</code></pre>
<p>Когда вы обернете заголовок в компоненте <code>Link</code> и сошлетесь на слаг поста, Gatsby добавит немного магии в ссылку, предварительно загрузит ее и сделает переход между страницами невероятно быстрым:</p>
<p><img src="https://www.gatsbyjs.org/0b343004a523df5633da47bed95eecab/wordpress-source-plugin-home-to-post-links.gif" alt="Конечный продукт со ссылками с главной страницы на посты в блоге"></p>
<h3>Заканчиваю работу.</h3>
<p>Вы можете применить ту же процедуру вызывая и создавая страницы, пользовательские типы записей, пользовательские поля, таксономии и прочий интересный и гибкий контент, которым славится WordPress.</p>

      </div>
    </div>
    <footer class="footer"> 
      <div class="footer__content content">
        <div class="footer__contacts" id="contacts"> <a class="footer__email-link" href="mailto:injashkin@gmail.com" title="Написать письмо">
            <svg class="icon icon__undefined" role="img" width="1em" height="1em">
              <use href="/sprite.svg#undefined"></use>
            </svg>
            <div class="footer__email">injashkin@gmail.com</div></a></div>
        <div class="footer__developer"> <a href="http://jinv.ru" target="_blank">Разработка сайта jinv.ru</a></div>
        <div class="footer__copyright-wrap">
          <div class="footer__copyright">jinv.ru © 2019 - 2022</div>
        </div>
      </div>
    </footer><!-- Yandex.Metrika counter -->
<script type="text/javascript">
  (function (m, e, t, r, i, k, a) {
    m[i] =
      m[i] ||
      function () {
        (m[i].a = m[i].a || []).push(arguments);
      };
    var z = null;
    m[i].l = 1 * new Date();
    for (var j = 0; j < document.scripts.length; j++) {
      if (document.scripts[j].src === r) {
        return;
      }
    }
    (k = e.createElement(t)),
      (a = e.getElementsByTagName(t)[0]),
      (k.async = 1),
      (k.src = r),
      a.parentNode.insertBefore(k, a);
  })(window, document, 'script', 'https://mc.yandex.ru/metrika/tag.js', 'ym');

  ym(60672532, 'init', {
    clickmap: true,
    trackLinks: true,
    accurateTrackBounce: true,
  });
</script>
<noscript
  ><div>
    <img
      src="https://mc.yandex.ru/watch/60672532"
      style="position: absolute; left: -9999px"
      alt=""
    /></div
></noscript>
<!-- /Yandex.Metrika counter -->

  </body>
</html>